name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  IMAGE_NAME: devops-tech-challenge-app
  JFROG_DOCKER_REPO: docker-trial
  APP_PORT: 3000

jobs:
  build-image:
    name: Build Docker image
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Infer short sha
        id: vars
        run: echo "short_sha=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT

      - name: Build image
        run: docker build -t "${IMAGE_NAME}:ci" .

      - name: Save image as artifact
        run: |
          docker save "${IMAGE_NAME}:ci" | gzip > image-ci.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-ci
          path: image-ci.tar.gz
          retention-days: 1

  smoke-test:
    name: Smoke test (Compose)
    runs-on: ubuntu-latest
    needs: build-image
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-ci

      - name: Load image
        run: |
          gunzip -c image-ci.tar.gz | docker load
          docker image ls | head

      - name: Smoke test (docker compose, JSON only)
        run: |
          # Override app to use prebuilt image instead of build:
          cat > docker-compose.ci.override.yml <<'YAML'
          services:
            app:
              image: devops-tech-challenge-app:ci
              build: null
          YAML

          docker compose --env-file env/dev.env \
            -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.ci.override.yml \
            up -d --no-build

          echo "Waiting for app to be ready..."
          for i in {1..40}; do
            if curl -sSf "http://localhost:${APP_PORT}/" >/dev/null; then
              echo "App is responding."
              break
            fi
            sleep 3
          done

          echo "Hitting endpoint..."
          curl -sSf "http://localhost:${APP_PORT}/" -o /tmp/resp.json

          echo "Validating JSON..."
          python -m json.tool /tmp/resp.json >/dev/null

          echo "Smoke test passed!"

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

  push-jfrog:
    name: Push to JFrog
    runs-on: ubuntu-latest
    needs: [build-image, smoke-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    defaults:
      run:
        shell: bash
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-ci

      - name: Load image
        run: |
          gunzip -c image-ci.tar.gz | docker load

      - name: Push to JFrog
        run: |
          set -e
          SHORT_SHA="${{ needs.build-image.outputs.short_sha }}"
          REGISTRY="trial29e6cp.jfrog.io"

          docker login "$REGISTRY" \
            -u "${{ secrets.JFROG_USERNAME }}" \
            -p "${{ secrets.JFROG_TOKEN }}"

          FULL_TAG="$REGISTRY/${JFROG_DOCKER_REPO}/${IMAGE_NAME}:docker-${SHORT_SHA}"
          echo "Pushing: $FULL_TAG"

          docker tag "${IMAGE_NAME}:ci" "$FULL_TAG"
          docker push "$FULL_TAG"
        env:        
          JFROG_DOCKER_REPO: ${{ secrets.JFROG_DOCKER_REPO }}
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_TOKEN: ${{ secrets.JFROG_TOKEN }}