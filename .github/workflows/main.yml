# name: CI/CD Pipeline

# on:
#   push:
#     branches: ["main"]
#   pull_request:
#     branches: ["main"]

# concurrency:
#   group: ci-${{ github.ref }}
#   cancel-in-progress: true

# env:
#   IMAGE_NAME: devops-tech-challenge-app
#   APP_PORT: 3000

# jobs:
#   build-image:
#     name: Build Docker image
#     runs-on: ubuntu-latest
#     defaults:
#       run:
#         shell: bash
#     outputs:
#       short_sha: ${{ steps.vars.outputs.short_sha }}
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Infer short sha
#         id: vars
#         run: echo "short_sha=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT

#       - name: Build image
#         run: docker build -t "${IMAGE_NAME}:ci" .

#       - name: Save image as artifact
#         run: docker save "${IMAGE_NAME}:ci" | gzip > image-ci.tar.gz

#       - name: Upload image artifact
#         uses: actions/upload-artifact@v4
#         with:
#           name: docker-image-ci
#           path: image-ci.tar.gz
#           retention-days: 1

#   smoke-test:
#     name: Smoke test (Compose)
#     runs-on: ubuntu-latest
#     needs: build-image
#     defaults:
#       run:
#         shell: bash
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Download image artifact
#         uses: actions/download-artifact@v4
#         with:
#           name: docker-image-ci

#       - name: Load image
#         run: |
#           gunzip -c image-ci.tar.gz | docker load
#           docker image ls | head

#       - name: Smoke test (docker compose, JSON only)
#         run: |
#           # Force compose to use the prebuilt image.
#           cat > docker-compose.ci.override.yml <<'YAML'
#           services:
#             app:
#               image: devops-tech-challenge-app:ci
#           YAML

#           docker compose --env-file env/dev.env \
#             -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.ci.override.yml \
#             up -d --no-build

#           echo "Waiting for app to be ready..."
#           for i in {1..40}; do
#             if curl -sSf "http://localhost:${APP_PORT}/" >/dev/null; then
#               echo "App is responding."
#               break
#             fi
#             sleep 3
#           done

#           echo "Hitting endpoint..."
#           curl -sSf "http://localhost:${APP_PORT}/" -o /tmp/resp.json

#           echo "Validating JSON..."
#           python -m json.tool /tmp/resp.json >/dev/null

#           echo "Smoke test passed!"

#       - name: Show logs on failure
#         if: failure()
#         run: |
#           docker compose ps
#           docker compose logs --no-color

#       - name: Cleanup
#         if: always()
#         run: docker compose down -v

#   push-jfrog-and-bump:
#     name: Push to JFrog + bump Helm dev/test tags
#     runs-on: ubuntu-latest
#     needs: [build-image, smoke-test]
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#     permissions:
#       contents: write
#     defaults:
#       run:
#         shell: bash
#     steps:
#       - name: Checkout repo (for values update)
#         uses: actions/checkout@v4
#         with:
#           ref: main
#           fetch-depth: 0

#       - name: Download image artifact
#         uses: actions/download-artifact@v4
#         with:
#           name: docker-image-ci

#       - name: Load image
#         run: gunzip -c image-ci.tar.gz | docker load

#       - name: Push to JFrog + Deploy
#         run: |
#           set -euo pipefail
#           SHORT_SHA="${{ needs.build-image.outputs.short_sha }}"
#           REGISTRY="trial29e6cp.jfrog.io"
#           REPO="docker-trial"
#           IMAGE="devops-tech-challenge-app"

#           echo "${{ secrets.JFROG_TOKEN }}" | docker login "$REGISTRY" \
#             -u "${{ secrets.JFROG_USERNAME }}" --password-stdin

#           FULL_TAG="$REGISTRY/$REPO/$IMAGE:docker-${SHORT_SHA}"
#           echo "Pushing: $FULL_TAG"

#           docker tag "$IMAGE:ci" "$FULL_TAG"
#           docker push "$FULL_TAG"

#       - name: Update Helm dev & test image tags (must change)
#         run: |
#           set -euo pipefail
#           SHORT_SHA="${{ needs.build-image.outputs.short_sha }}"

#           DEV_FILE="charts/devops-tech-challenge/environments/dev/values.yaml"
#           TEST_FILE="charts/devops-tech-challenge/environments/test/values.yaml"

#           for FILE in "$DEV_FILE" "$TEST_FILE"; do
#             [[ -f "$FILE" ]] || { echo "ERROR: missing $FILE"; exit 1; }

#             echo "Before ($FILE):"
#             grep -nE '^[[:space:]]*tag:' "$FILE" || { echo "ERROR: tag: not found in $FILE"; exit 1; }

#             sed -i -E "s|^([[:space:]]*tag:[[:space:]]*).*$|\1\"docker-${SHORT_SHA}\"|g" "$FILE"

#             echo "After ($FILE):"
#             grep -nE '^[[:space:]]*tag:' "$FILE"

#             grep -qE "^[[:space:]]*tag:[[:space:]]*\"docker-${SHORT_SHA}\"" "$FILE" \
#               || { echo "ERROR: failed to set tag in $FILE"; exit 1; }
#           done

#           git diff -- "$DEV_FILE" "$TEST_FILE"

#       - name: Commit and push values change
#         run: |
#           set -euo pipefail
#           SHORT_SHA="${{ needs.build-image.outputs.short_sha }}"
#           git config user.name "github-actions[bot]"
#           git config user.email "github-actions[bot]@users.noreply.github.com"
#           git add charts/devops-tech-challenge/environments/dev/values.yaml \
#                   charts/devops-tech-challenge/environments/test/values.yaml
#           git commit -m "chore(deploy): bump dev/test image tag to docker-${SHORT_SHA}" || exit 0
#           git push origin HEAD:main
