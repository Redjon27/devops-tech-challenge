name: ci

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  unit_and_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci || npm install

      - name: Unit tests
        run: npm test

      - name: Build app
        run: npm run build

      - name: Build Docker image
        run: docker build -t devops-tech-challenge-app:ci .

  smoke_compose:
    runs-on: ubuntu-latest
    needs: unit_and_build
    steps:
      - uses: actions/checkout@v4

      - name: Build + start stack
        run: |
          docker compose --env-file env/test.env -f docker-compose.yml -f docker-compose.test.yml up -d --build

      - name: Wait for app
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:3002 >/dev/null; then
              echo "App is up"
              exit 0
            fi
            sleep 2
          done
          echo "App did not become ready"
          docker compose ps
          docker compose logs --no-color app
          exit 1

      - name: Smoke request
        run: |
          curl -s http://localhost:3002 | tee /tmp/resp.json
          grep -q '"request":"\[GET\] /"' /tmp/resp.json

      - name: Teardown
        if: always()
        run: docker compose down -v