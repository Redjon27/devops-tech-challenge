name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  IMAGE_NAME: devops-tech-challenge-app
  JFROG_DOCKER_REPO: docker-trial
  APP_PORT: 3000

jobs:
  unit-tests:
    name: Unit tests (Node)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci || npm install

      - name: Run unit tests
        run: npm test

      - name: Build app
        run: npm run build

  docker-build-smoke:
    name: Docker build + Smoke test + Push to JFrog
    runs-on: ubuntu-latest
    needs: unit-tests
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set SHORT_SHA
        run: echo "SHORT_SHA=${GITHUB_SHA:0:8}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (local tag)
        run: |
          docker build -t "${IMAGE_NAME}:ci" .

      - name: Smoke test (docker compose up)
        run: |
          docker compose --env-file env/dev.env -f docker-compose.yml -f docker-compose.dev.yml up -d --build

          echo "Waiting for app to be ready..."
          for i in {1..40}; do
            if curl -sSf "http://localhost:${APP_PORT}/" >/dev/null; then
              echo "App is responding."
              break
            fi
            sleep 3
          done

          echo "Hitting endpoint..."
          curl -sSf "http://localhost:${APP_PORT}/" | tee /tmp/resp.json

          if ! grep -q '"request":"\[GET\] /"' /tmp/resp.json; then
            echo "Unexpected response:"
            cat /tmp/resp.json
            exit 1
          fi

          echo "Smoke test passed!"

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

      - name: Docker push to JFrog (simple)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -e

          REGISTRY="trial29e6cp.jfrog.io"
          REPO="${JFROG_DOCKER_REPO}"
          IMAGE="${IMAGE_NAME}"
          TAG="docker-${SHORT_SHA}"

          docker login "$REGISTRY" \
            -u "${{ secrets.JFROG_USERNAME }}" \
            -p "${{ secrets.JFROG_TOKEN }}"

          docker tag "$IMAGE:ci" "$REGISTRY/$REPO/$IMAGE:$TAG"
          docker push "$REGISTRY/$REPO/$IMAGE:$TAG"
